<!DOCTYPE html>
<html>
<head>
    <title>Codex DM Screen</title>
    <link rel="icon" href="/favicon.ico">
    <style>
        body { display: flex; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; margin: 0; background: #1e1e1e; color: #e0e0e0; }
        #sidebar { width: 320px; background: #252526; display: flex; flex-direction: column; border-right: 1px solid #333; flex-shrink: 0; }
        #nav-header { padding: 15px; background: #2d2d2d; border-bottom: 1px solid #3e3e3e; font-weight: 600; color: #fff; user-select: none;}
        #nav-list { flex: 1; overflow-y: auto; padding: 8px; }
        .node-item { padding: 8px 12px; margin-bottom: 2px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; color: #ccc; user-select: none; }
        .node-item:hover { background: #2a2d2e; color: #fff; }
        .node-item.active { background: #007acc; color: #fff; }
        .node-item .icon { margin-right: 10px; width: 20px; text-align: center; }
        .nav-up { background: #3a3a40; margin-bottom: 10px; border: 1px solid #4a4a50; color: #aaddff; font-weight: bold;}
        .nav-up:hover { background: #4a4a50; }
        #editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor-header { padding: 20px 40px; border-bottom: 1px solid #333; }
        #editor-header h1 { margin: 0; font-size: 1.8em; font-weight: 300; }
        #editor-content { flex: 1; overflow-y: auto; padding: 40px; max-width: 900px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; color: #858585; font-size: 0.85em; font-weight: 600; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 10px; background: #3c3c3c; border: 1px solid #3c3c3c; color: #f0f0f0; border-radius: 2px; font-family: inherit; font-size: 1em; box-sizing: border-box; }
        .btn { padding: 10px 24px; border: none; border-radius: 2px; cursor: pointer; font-size: 0.9em; font-weight: 600; background: #0e639c; color: white; }
    </style>
</head>
<body>
<div id="sidebar"><div id="nav-header">Campaigns</div><div id="nav-list"></div></div>
<div id="editor-container">
    <div id="editor-header"><h1>Codex Engine</h1></div>
    <div id="editor-content"></div>
    <div style="padding: 20px 40px; border-top: 1px solid #333; text-align: right;"><button class="btn" id="save-btn" style="display:none">Save Changes</button></div>
</div>
<script>
    const API_URL = "/api";
    let navStack = [];
    let currentUid = null;

    async function init() {
        const res = await fetch(`${API_URL}/tree`);
        const children = await res.json();
        // Root nodes have no parent (null)
        renderSidebar(children, null);
    }

    async function navigateTo(uid, title) {
        if (uid === null) { init(); return; }
        
        currentUid = uid;
        document.getElementById('nav-header').innerText = title;
        
        const res = await fetch(`${API_URL}/tree/${uid}`);
        const node = await res.json();
        
        // Use node.parent_uid from the server instead of a local stack
        renderSidebar(node.children, node.parent_uid);
        renderEditor(node);
    }

    function renderSidebar(children, parentUid) {
        const list = document.getElementById('nav-list');
        list.innerHTML = '';

        // TARGETED FIX: Back button now relies on the server's parent_uid
        // If currentUid is set, we are in a node and can go back (even to root/null)
        if (currentUid !== null) {
            const backBtn = document.createElement('div');
            backBtn.className = 'node-item nav-up';
            backBtn.innerHTML = `<span class="icon">⬅️</span> Back`;
            backBtn.onclick = () => navigateTo(parentUid, "Back");
            list.appendChild(backBtn);
        }

        children.forEach(c => {
            const div = document.createElement('div');
            div.className = 'node-item';
            div.innerHTML = `<span class="icon">${c.icon}</span> ${c.name}`;
            div.onclick = () => navigateTo(c.uid, c.name);
            list.appendChild(div);
        });
    }

    function renderEditor(node) {
        document.getElementById('editor-header').innerHTML = `<h1>${node.name}</h1>`;
        const container = document.getElementById('editor-content');
        container.innerHTML = '';
        
        const form = document.createElement('div');

        node.ui_schema.forEach(field => {
            const group = document.createElement('div'); 
            group.className = 'form-group';
            const lbl = document.createElement('label'); 
            lbl.innerText = field.label; 
            group.appendChild(lbl);
            
            let input;
            const val = node.data[field.key] || "";
            
            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = 5;
                input.value = val;
            } else {
                input = document.createElement('input');
                input.type = 'text'; 
                input.value = val;
            }
            
            if(field.readonly) input.disabled = true;
            input.id = `field_${field.key}`;
            group.appendChild(input);
            form.appendChild(group);
        });
        
        container.appendChild(form);

        const btn = document.getElementById('save-btn');
        btn.style.display = 'inline-block';
        btn.onclick = () => saveData(node.uid, node.ui_schema);
    }

    async function saveData(uid, schema) {
        const payload = {};
        schema.forEach(field => {
            if(field.readonly) return;
            const el = document.getElementById(`field_${field.key}`);
            if(el) payload[field.key] = el.value;
        });

        const btn = document.getElementById('save-btn');
        btn.innerText = "Saving..."; 
        btn.disabled = true;
        
        await fetch(`${API_URL}/tree/${uid}`, { 
            method: 'PATCH', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ data: payload }) 
        });
        
        btn.innerText = "Saved!";
        setTimeout(() => { btn.innerText = "Save Changes"; btn.disabled = false; }, 1000);
    }

    init();
</script>
</body>
</html>
